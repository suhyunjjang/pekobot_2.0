<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바이낸스 비트코인 선물 차트 (다크 테마)</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --background: hsl(206 48% 11%);
            --foreground: hsl(210 17% 85%);
            --card: hsl(206 48% 15%);
            --card-foreground: hsl(210 17% 85%);
            --primary: hsl(145 44% 51%);
            --primary-foreground: hsl(206 48% 5%);
            --secondary: hsl(210 20% 30%);
            --secondary-foreground: hsl(210 17% 85%);
            --muted-foreground: hsl(210 17% 55%);
            --border: hsl(206 40% 25%);
            --chart-1-blue: hsl(220 70% 50%); /* --chart-1 (Blue) */
            --chart-2-green: hsl(160 60% 45%); /* --chart-2 (Green) for price-value */
            --chart-destructive: hsl(0 72% 57%); /* --destructive (Red) for downColor */
            --chart-accent-orange: hsl(30 80% 55%); /* --chart-3 (Yellow/Orange) for Stoch D */
            --chart-bg-forced: #1c252e; /* 강제 적용할 차트 배경색 변수 */
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
        }
        .charts-wrapper { 
            display: flex;
            width: 100%;
            gap: 20px;
        }
        .chart-group { 
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--card);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 15px;
            margin-bottom: 20px; 
            border: 1px solid var(--border);
        }
        #chart-container, #ha-chart-container {
            width: 100%;
            height: 350px; 
            margin-bottom: 10px;
            background-color: var(--chart-bg-forced) !important;
        }
        #stoch-rsi-chart-container, #ha-stoch-rsi-chart-container { 
            width: 100%;
            height: 100px; 
            margin-top: 5px;
            margin-bottom: 10px;
            background-color: var(--chart-bg-forced) !important;
        }
        h1 {
            color: var(--card-foreground);
            text-align: center;
            font-size: 1.5em; 
            margin-top: 0;
            margin-bottom: 10px;
        }
        .price-info {
            text-align: center;
            width: 100%;
            margin-top: 10px;
        }
        .price-info p {
            margin: 5px 0;
            font-size: 16px; 
            color: var(--muted-foreground);
        }
        .price-value {
            font-weight: bold;
            color: var(--chart-2-green);
        }

        .strategy-status li span {
            font-weight: bold;
        }
        .status-true {
            color: hsl(145 44% 51%);
        }
        .status-false {
            color: hsl(0 72% 57%);
        }
        .signal-long {
            color: hsl(145 44% 61%);
            font-weight: bold;
        }
        .signal-short {
            color: hsl(0 72% 67%);
            font-weight: bold;
        }
        .signal-none {
            color: var(--muted-foreground);
        }
        .info-row {
            display: flex;
            gap: 20px;
            width: 100%;
            margin-top: 20px;
        }
        .info-card {
            flex: 1;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--card);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
        }
        .wallet-balance h4, .strategy-status h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--foreground);
            font-size: 1.1em;
            text-align: center;
        }
        .wallet-balance p, .strategy-status p,
        .strategy-status ul {
            margin: 8px 0;
            font-size: 0.9em;
            color: var(--muted-foreground);
        }
        .strategy-status ul {
            list-style: none;
            padding-left: 0;
        }
    </style>
</head>
<body>
    <div class="charts-wrapper">
        <div class="chart-group">
            <h1>일반 캔들 차트</h1>
    <div id="chart-container"></div>
            <div id="stoch-rsi-chart-container"></div>
    <div class="price-info">
        <p>현재가: <span id="current-price" class="price-value">로딩 중...</span></p>
            </div>
        </div>
        <div class="chart-group">
            <h1>하이킨아시 캔들 차트</h1>
            <div id="ha-chart-container"></div>
            <div id="ha-stoch-rsi-chart-container"></div>
            <div class="price-info">
                <p>현재가: <span id="ha-current-price" class="price-value">로딩 중...</span></p>
            </div>
        </div>
    </div>

    <div class="info-row">
        <div class="wallet-balance info-card">
            <h4>선물 지갑 잔고</h4>
            <p>USDT: <span id="balance-usdt">로딩 중...</span></p>
            <p>총 평가액 (USDT): <span id="balance-total-usdt">로딩 중...</span></p>
        </div>
        <div class="strategy-status info-card">
            <h4>매매 신호 (HA 기준)</h4>
            <p>포지션: <span id="ha-current-position">-</span></p>
            <p>최근 신호: <strong id="ha-signal-type" class="signal-none">-</strong></p>
            <p>신호 시간: <span id="ha-signal-time">-</span></p>
            <ul>
                <li>매수 조건:</li>
                <li>&nbsp;&nbsp;추세 (HA종가 &gt; EMA200): <span id="ha-cond-long-trend">-</span></li>
                <li>&nbsp;&nbsp;방향 (HA양봉): <span id="ha-cond-long-direction">-</span></li>
                <li>&nbsp;&nbsp;StochRSI (20 상향돌파): <span id="ha-cond-long-oscillator">-</span></li>
            </ul>
            <ul>
                <li>매도 조건:</li>
                <li>&nbsp;&nbsp;추세 (HA종가 &lt; EMA200): <span id="ha-cond-short-trend">-</span></li>
                <li>&nbsp;&nbsp;방향 (HA음봉): <span id="ha-cond-short-direction">-</span></li>
                <li>&nbsp;&nbsp;StochRSI (80 하향돌파): <span id="ha-cond-short-oscillator">-</span></li>
            </ul>
        </div>
    </div>

    <script>
        const socket = io();
        
        let chart, candleSeries, ema200Series, stochRsiChart, stochKSeries, stochDSeries, stochRsiOverboughtLine, stochRsiOversoldLine;
        let haChart, haCandleSeries, haEma200Series, haStochRsiChart, haStochKSeries, haStochDSeries, haStochRsiOverboughtLine, haStochRsiOversoldLine;
        
        const chartContainer = document.getElementById('chart-container');
        const currentPriceElement = document.getElementById('current-price');
        const haChartContainer = document.getElementById('ha-chart-container');
        const haCurrentPriceElement = document.getElementById('ha-current-price');
        const stochRsiChartContainer = document.getElementById('stoch-rsi-chart-container');
        const haStochRsiChartContainer = document.getElementById('ha-stoch-rsi-chart-container');
        const haCurrentPositionEl = document.getElementById('ha-current-position');
        const haSignalTypeEl = document.getElementById('ha-signal-type');
        const haSignalTimeEl = document.getElementById('ha-signal-time');
        const haCondLongTrendEl = document.getElementById('ha-cond-long-trend');
        const haCondLongDirectionEl = document.getElementById('ha-cond-long-direction');
        const haCondLongOscillatorEl = document.getElementById('ha-cond-long-oscillator');
        const haCondShortTrendEl = document.getElementById('ha-cond-short-trend');
        const haCondShortDirectionEl = document.getElementById('ha-cond-short-direction');
        const haCondShortOscillatorEl = document.getElementById('ha-cond-short-oscillator');

        const balanceUsdtEl = document.getElementById('balance-usdt');
        const balanceTotalUsdtEl = document.getElementById('balance-total-usdt');

        let isChartReady = false;

        async function fetchWalletBalance() {
            if (!balanceUsdtEl || !balanceTotalUsdtEl) return;
            try {
                balanceUsdtEl.textContent = '로딩 중...';
                balanceTotalUsdtEl.textContent = '로딩 중...';
                
                const response = await fetch('/api/futures-balance');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const balanceData = await response.json();

                if (balanceData) {
                    balanceUsdtEl.textContent = `${parseFloat(balanceData.usdtBalance || 0).toFixed(2)} USDT`;
                    balanceTotalUsdtEl.textContent = `${parseFloat(balanceData.totalWalletBalanceUsdt || 0).toFixed(2)} USDT`;
                } else {
                    throw new Error('잔고 데이터를 받지 못했습니다.');
                }
            } catch (error) {
                console.error('선물 지갑 잔고 로드 오류:', error);
                balanceUsdtEl.textContent = '로드 실패';
                balanceTotalUsdtEl.textContent = '로드 실패';
            }
        }

        async function fetchHistoricalData() {
            try {
                currentPriceElement.textContent = '데이터 로딩 중...';
                haCurrentPriceElement.textContent = '데이터 로딩 중...';
                const response = await fetch('/api/historical-klines');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const allChartData = await response.json();

                const commonChartOptions = {
                    layout: {
                        background: { type: 'solid', color: 'hsl(206 48% 15%)' },
                        textColor: 'hsl(210 17% 85%)',
                    },
                    grid: { vertLines: { color: 'hsl(206 40% 25%)' }, horzLines: { color: 'hsl(206 40% 25%)' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    timeScale: { borderColor: 'hsl(206 40% 25%)', timeVisible: true, secondsVisible: false },
                    rightPriceScale: { borderColor: 'hsl(206 40% 25%)' }
                };
                const commonStochRsiOptions = {
                    layout: {
                        background: { type: 'solid', color: 'hsl(206 48% 15%)' },
                        textColor: 'hsl(210 17% 85%)',
                    },
                    grid: { vertLines: { visible: false }, horzLines: { color: 'hsl(206 40% 20%)' } },
                    timeScale: { visible: false }, 
                    rightPriceScale: { visible: true, mode: LightweightCharts.PriceScaleMode.Normal, borderColor: 'hsl(206 40% 25%)' }
                };

                if (!chart) {
                    chart = LightweightCharts.createChart(chartContainer, { width: chartContainer.clientWidth, height: chartContainer.clientHeight, ...commonChartOptions });
                    candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, { upColor: 'hsl(145 44% 51%)', downColor: 'hsl(0 72% 57%)', borderDownColor: 'hsl(0 72% 57%)', borderUpColor: 'hsl(145 44% 51%)', wickDownColor: 'hsl(0 72% 57%)', wickUpColor: 'hsl(145 44% 51%)' });
                    ema200Series = chart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                }
                if (!stochRsiChart) {
                    stochRsiChart = LightweightCharts.createChart(stochRsiChartContainer, { width: stochRsiChartContainer.clientWidth, height: stochRsiChartContainer.clientHeight, ...commonStochRsiOptions });
                    stochKSeries = stochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    stochDSeries = stochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(30 80% 55%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    stochRsiOverboughtLine = stochKSeries.createPriceLine({ price: 80, color: 'hsla(0, 72%, 57%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '80' });
                    stochRsiOversoldLine = stochKSeries.createPriceLine({ price: 20, color: 'hsla(145, 44%, 51%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '20' });
                }
                if (!haChart) {
                    haChart = LightweightCharts.createChart(haChartContainer, { width: haChartContainer.clientWidth, height: haChartContainer.clientHeight, ...commonChartOptions });
                    haCandleSeries = haChart.addSeries(LightweightCharts.CandlestickSeries, { upColor: 'hsl(145 44% 51%)', downColor: 'hsl(0 72% 57%)', borderDownColor: 'hsl(0 72% 57%)', borderUpColor: 'hsl(145 44% 51%)', wickDownColor: 'hsl(0 72% 57%)', wickUpColor: 'hsl(145 44% 51%)' });
                    haEma200Series = haChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                }
                if (!haStochRsiChart) {
                    haStochRsiChart = LightweightCharts.createChart(haStochRsiChartContainer, { width: haStochRsiChartContainer.clientWidth, height: haStochRsiChartContainer.clientHeight, ...commonStochRsiOptions });
                    haStochKSeries = haStochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    haStochDSeries = haStochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(30 80% 55%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    haStochRsiOverboughtLine = haStochKSeries.createPriceLine({ price: 80, color: 'hsla(0, 72%, 57%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '80' });
                    haStochRsiOversoldLine = haStochKSeries.createPriceLine({ price: 20, color: 'hsla(145, 44%, 51%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '20' });
                }

                updateAllChartSeries(allChartData);
                isChartReady = true;

            } catch (error) {
                console.error('과거 데이터 로드 및 차트 생성 오류:', error);
                currentPriceElement.textContent = '로드 실패';
                haCurrentPriceElement.textContent = '로드 실패';
                isChartReady = false;
            }
        }

        function updateStrategyStatusUI(strategySignal) {
            if (!strategySignal) return;

            haCurrentPositionEl.textContent = strategySignal.position || '-';
            let signalText = '신호 없음';
            let signalClass = 'signal-none';

            if (strategySignal.signal === 'LONG_ENTRY') {
                signalText = '매수 진입 신호';
                signalClass = 'signal-long';
            } else if (strategySignal.signal === 'SHORT_ENTRY') {
                signalText = '매도 진입 신호';
                signalClass = 'signal-short';
            } else if (strategySignal.signal === 'DATA_INSUFFICIENT') {
                signalText = '데이터 부족';
            }
            haSignalTypeEl.textContent = signalText;
            haSignalTypeEl.className = signalClass;
            haSignalTimeEl.textContent = strategySignal.timestamp > 0 ? new Date(strategySignal.timestamp * 1000).toLocaleString() : '-';

            function updateConditionElement(el, met) {
                if (typeof met === 'boolean') {
                    el.textContent = met ? '충족' : '미충족';
                    el.className = met ? 'status-true' : 'status-false';
                } else {
                    el.textContent = '-';
                    el.className = '';
                }
            }
            
            if (strategySignal.conditions) {
                if (strategySignal.conditions.long) {
                    updateConditionElement(haCondLongTrendEl, strategySignal.conditions.long.trend);
                    updateConditionElement(haCondLongDirectionEl, strategySignal.conditions.long.direction);
                    updateConditionElement(haCondLongOscillatorEl, strategySignal.conditions.long.oscillator);
                }
                if (strategySignal.conditions.short) {
                    updateConditionElement(haCondShortTrendEl, strategySignal.conditions.short.trend);
                    updateConditionElement(haCondShortDirectionEl, strategySignal.conditions.short.direction);
                    updateConditionElement(haCondShortOscillatorEl, strategySignal.conditions.short.oscillator);
                }
            }
        }

        function updateAllChartSeries(allChartData) {
            if (!allChartData) return;

            if (candleSeries) candleSeries.setData(allChartData.regularCandles || []);
            if (ema200Series) ema200Series.setData(allChartData.regularEMA200 || []);
            if (stochKSeries) stochKSeries.setData(allChartData.regularStochRSI ? allChartData.regularStochRSI.kLine : []);
            if (stochDSeries) stochDSeries.setData(allChartData.regularStochRSI ? allChartData.regularStochRSI.dLine : []);
            
            if (haCandleSeries) haCandleSeries.setData(allChartData.heikinAshiCandles || []);
            if (haEma200Series) haEma200Series.setData(allChartData.heikinAshiEMA200 || []);
            if (haStochKSeries) haStochKSeries.setData(allChartData.heikinAshiStochRSI ? allChartData.heikinAshiStochRSI.kLine : []);
            if (haStochDSeries) haStochDSeries.setData(allChartData.heikinAshiStochRSI ? allChartData.heikinAshiStochRSI.dLine : []);

            if (allChartData.regularCandles && allChartData.regularCandles.length > 0) {
                const lastCandle = allChartData.regularCandles[allChartData.regularCandles.length - 1];
                currentPriceElement.textContent = parseFloat(lastCandle.close).toFixed(2) + ' USDT';
            } else { currentPriceElement.textContent = '데이터 없음'; }
            if (allChartData.heikinAshiCandles && allChartData.heikinAshiCandles.length > 0) {
                const lastHaCandle = allChartData.heikinAshiCandles[allChartData.heikinAshiCandles.length - 1];
                haCurrentPriceElement.textContent = parseFloat(lastHaCandle.close).toFixed(2) + ' USDT';
            } else { haCurrentPriceElement.textContent = '데이터 없음'; }

            if (allChartData.strategySignal) {
                updateStrategyStatusUI(allChartData.strategySignal);
            }
        }
        
        socket.on('full_chart_update', (allCalculatedData) => {
            if (isChartReady) {
                updateAllChartSeries(allCalculatedData);
            }
        });
        
        async function initializePage() {
            await fetchHistoricalData();
            await fetchWalletBalance();
        }

        initializePage();

        window.addEventListener('resize', () => {
            if (chart) chart.applyOptions({ width: chartContainer.clientWidth, height: chartContainer.clientHeight });
            if (haChart) haChart.applyOptions({ width: haChartContainer.clientWidth, height: haChartContainer.clientHeight });
            if (stochRsiChart) stochRsiChart.applyOptions({ width: stochRsiChartContainer.clientWidth, height: stochRsiChartContainer.clientHeight });
            if (haStochRsiChart) haStochRsiChart.applyOptions({ width: haStochRsiChartContainer.clientWidth, height: haStochRsiChartContainer.clientHeight });
        });
    </script>
</body>
</html> 