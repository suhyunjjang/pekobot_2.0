<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>바이낸스 비트코인 선물 차트 (다크 테마)</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            /* Dark Theme Colors from color_usage.md */
            --background: hsl(206 48% 11%);
            --foreground: hsl(210 17% 85%);
            --card: hsl(206 48% 15%);
            --card-foreground: hsl(210 17% 85%);
            --primary: hsl(145 44% 51%);
            --primary-foreground: hsl(206 48% 5%);
            --secondary: hsl(210 20% 30%);
            --secondary-foreground: hsl(210 17% 85%);
            --muted-foreground: hsl(210 17% 55%);
            --border: hsl(206 40% 25%);
            --chart-1-blue: hsl(220 70% 50%); /* --chart-1 (Blue) */
            --chart-2-green: hsl(160 60% 45%); /* --chart-2 (Green) for price-value */
            --chart-destructive: hsl(0 72% 57%); /* --destructive (Red) for downColor */
            --chart-accent-orange: hsl(30 80% 55%); /* --chart-3 (Yellow/Orange) for Stoch D */
            --chart-bg-forced: #1c252e; /* 강제 적용할 차트 배경색 변수 */
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
        }
        .charts-wrapper { 
            display: flex;
            width: 100%;
            gap: 20px;
        }
        .chart-group { 
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--card);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 15px;
            margin-bottom: 20px; 
            border: 1px solid var(--border);
        }
        #chart-container, #ha-chart-container {
            width: 100%;
            height: 350px; 
            margin-bottom: 10px;
            background-color: var(--chart-bg-forced) !important; /* CSS로 차트 배경색 강제 지정 */
        }
        #stoch-rsi-chart-container, #ha-stoch-rsi-chart-container { 
            width: 100%;
            height: 100px; 
            margin-top: 5px;
            margin-bottom: 10px;
            background-color: var(--chart-bg-forced) !important; /* CSS로 차트 배경색 강제 지정 */
        }
        h1 {
            color: var(--card-foreground);
            text-align: center;
            font-size: 1.5em; 
            margin-top: 0;
            margin-bottom: 10px;
        }
        .price-info {
            text-align: center;
            width: 100%;
        }
        .price-info p {
            margin: 5px 0;
            font-size: 16px; 
            color: var(--muted-foreground);
        }
        .price-value {
            font-weight: bold;
            color: var(--chart-2-green); /* Using chart green for price value */
        }
    </style>
</head>
<body>
    <div class="charts-wrapper">
        <div class="chart-group">
            <h1>일반 캔들 차트</h1>
            <div id="chart-container"></div>
            <div id="stoch-rsi-chart-container"></div>
            <div class="price-info">
                <p>현재가: <span id="current-price" class="price-value">로딩 중...</span></p>
            </div>
        </div>
        <div class="chart-group">
            <h1>하이킨아시 캔들 차트</h1>
            <div id="ha-chart-container"></div>
            <div id="ha-stoch-rsi-chart-container"></div>
            <div class="price-info">
                <p>현재가: <span id="ha-current-price" class="price-value">로딩 중...</span></p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        let chart, candleSeries, ema200Series, stochRsiChart, stochKSeries, stochDSeries, stochRsiOverboughtLine, stochRsiOversoldLine;
        let haChart, haCandleSeries, haEma200Series, haStochRsiChart, haStochKSeries, haStochDSeries, haStochRsiOverboughtLine, haStochRsiOversoldLine;
        
        const chartContainer = document.getElementById('chart-container');
        const currentPriceElement = document.getElementById('current-price');
        const haChartContainer = document.getElementById('ha-chart-container');
        const haCurrentPriceElement = document.getElementById('ha-current-price');
        const stochRsiChartContainer = document.getElementById('stoch-rsi-chart-container');
        const haStochRsiChartContainer = document.getElementById('ha-stoch-rsi-chart-container');

        let isChartReady = false; // 차트 및 시리즈 준비 완료 플래그

        async function fetchHistoricalData() {
            try {
                currentPriceElement.textContent = '데이터 로딩 중...';
                haCurrentPriceElement.textContent = '데이터 로딩 중...';
                const response = await fetch('/api/historical-klines');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const allChartData = await response.json();

                const commonChartOptions = {
                    layout: {
                        background: { type: 'solid', color: 'hsl(206 48% 15%)' },
                        textColor: 'hsl(210 17% 85%)',
                    },
                    grid: { vertLines: { color: 'hsl(206 40% 25%)' }, horzLines: { color: 'hsl(206 40% 25%)' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    timeScale: { borderColor: 'hsl(206 40% 25%)', timeVisible: true, secondsVisible: false },
                    rightPriceScale: { borderColor: 'hsl(206 40% 25%)' }
                };
                const commonStochRsiOptions = {
                    layout: {
                        background: { type: 'solid', color: 'hsl(206 48% 15%)' },
                        textColor: 'hsl(210 17% 85%)',
                    },
                    grid: { vertLines: { visible: false }, horzLines: { color: 'hsl(206 40% 20%)' } },
                    timeScale: { visible: false }, 
                    rightPriceScale: { visible: true, mode: LightweightCharts.PriceScaleMode.Normal, borderColor: 'hsl(206 40% 25%)' }
                };

                if (!chart) {
                    chart = LightweightCharts.createChart(chartContainer, { width: chartContainer.clientWidth, height: chartContainer.clientHeight, ...commonChartOptions });
                    candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, { upColor: 'hsl(145 44% 51%)', downColor: 'hsl(0 72% 57%)', borderDownColor: 'hsl(0 72% 57%)', borderUpColor: 'hsl(145 44% 51%)', wickDownColor: 'hsl(0 72% 57%)', wickUpColor: 'hsl(145 44% 51%)' });
                    ema200Series = chart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                }
                if (!stochRsiChart) {
                    stochRsiChart = LightweightCharts.createChart(stochRsiChartContainer, { width: stochRsiChartContainer.clientWidth, height: stochRsiChartContainer.clientHeight, ...commonStochRsiOptions });
                    stochKSeries = stochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    stochDSeries = stochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(30 80% 55%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    stochRsiOverboughtLine = stochKSeries.createPriceLine({ price: 80, color: 'hsla(0, 72%, 57%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '80' });
                    stochRsiOversoldLine = stochKSeries.createPriceLine({ price: 20, color: 'hsla(145, 44%, 51%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '20' });
                }
                if (!haChart) {
                    haChart = LightweightCharts.createChart(haChartContainer, { width: haChartContainer.clientWidth, height: haChartContainer.clientHeight, ...commonChartOptions });
                    haCandleSeries = haChart.addSeries(LightweightCharts.CandlestickSeries, { upColor: 'hsl(145 44% 51%)', downColor: 'hsl(0 72% 57%)', borderDownColor: 'hsl(0 72% 57%)', borderUpColor: 'hsl(145 44% 51%)', wickDownColor: 'hsl(0 72% 57%)', wickUpColor: 'hsl(145 44% 51%)' });
                    haEma200Series = haChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                }
                if (!haStochRsiChart) {
                    haStochRsiChart = LightweightCharts.createChart(haStochRsiChartContainer, { width: haStochRsiChartContainer.clientWidth, height: haStochRsiChartContainer.clientHeight, ...commonStochRsiOptions });
                    haStochKSeries = haStochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(220 70% 50%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    haStochDSeries = haStochRsiChart.addSeries(LightweightCharts.LineSeries, { color: 'hsl(30 80% 55%)', lineWidth: 1, lastValueVisible: false, priceLineVisible: false });
                    haStochRsiOverboughtLine = haStochKSeries.createPriceLine({ price: 80, color: 'hsla(0, 72%, 57%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '80' });
                    haStochRsiOversoldLine = haStochKSeries.createPriceLine({ price: 20, color: 'hsla(145, 44%, 51%, 0.7)', lineWidth: 1, lineStyle: LightweightCharts.LineStyle.Dashed, axisLabelVisible: true, title: '20' });
                }

                updateAllChartSeries(allChartData);
                isChartReady = true; // 모든 차트 및 시리즈 준비 완료

            } catch (error) {
                console.error('과거 데이터 로드 및 차트 생성 오류:', error);
                currentPriceElement.textContent = '로드 실패';
                haCurrentPriceElement.textContent = '로드 실패';
                isChartReady = false; // 오류 발생 시 false 유지
            }
        }

        function updateAllChartSeries(allChartData) {
            if (!allChartData) return;

            // 각 시리즈가 존재하는지 확인 후 setData 호출
            if (candleSeries) candleSeries.setData(allChartData.regularCandles || []);
            if (ema200Series) ema200Series.setData(allChartData.regularEMA200 || []);
            if (stochKSeries) stochKSeries.setData(allChartData.regularStochRSI ? allChartData.regularStochRSI.kLine : []);
            if (stochDSeries) stochDSeries.setData(allChartData.regularStochRSI ? allChartData.regularStochRSI.dLine : []);
            
            if (haCandleSeries) haCandleSeries.setData(allChartData.heikinAshiCandles || []);
            if (haEma200Series) haEma200Series.setData(allChartData.heikinAshiEMA200 || []);
            if (haStochKSeries) haStochKSeries.setData(allChartData.heikinAshiStochRSI ? allChartData.heikinAshiStochRSI.kLine : []);
            if (haStochDSeries) haStochDSeries.setData(allChartData.heikinAshiStochRSI ? allChartData.heikinAshiStochRSI.dLine : []);

            // 현재가 업데이트 (이전과 동일)
            if (allChartData.regularCandles && allChartData.regularCandles.length > 0) {
                const lastCandle = allChartData.regularCandles[allChartData.regularCandles.length - 1];
                currentPriceElement.textContent = parseFloat(lastCandle.close).toFixed(2) + ' USDT';
            } else { currentPriceElement.textContent = '데이터 없음'; }
            if (allChartData.heikinAshiCandles && allChartData.heikinAshiCandles.length > 0) {
                const lastHaCandle = allChartData.heikinAshiCandles[allChartData.heikinAshiCandles.length - 1];
                haCurrentPriceElement.textContent = parseFloat(lastHaCandle.close).toFixed(2) + ' USDT';
            } else { haCurrentPriceElement.textContent = '데이터 없음'; }
        }
        
        socket.on('full_chart_update', (allCalculatedData) => {
            if (isChartReady) { // 차트가 준비되었을 때만 업데이트 실행
                updateAllChartSeries(allCalculatedData);
            } else {
                // console.log('Received full_chart_update but chart is NOT ready yet');
            }
        });
        
        fetchHistoricalData();
        window.addEventListener('resize', () => {
            if (chart) chart.applyOptions({ width: chartContainer.clientWidth, height: chartContainer.clientHeight });
            if (haChart) haChart.applyOptions({ width: haChartContainer.clientWidth, height: haChartContainer.clientHeight });
            if (stochRsiChart) stochRsiChart.applyOptions({ width: stochRsiChartContainer.clientWidth, height: stochRsiChartContainer.clientHeight });
            if (haStochRsiChart) haStochRsiChart.applyOptions({ width: haStochRsiChartContainer.clientWidth, height: haStochRsiChartContainer.clientHeight });
        });
    </script>
</body>
</html> 